// Generated by CoffeeScript 1.8.0
var Alarm, User, log, time;

time = require('time');

log = require('printit')({
  prefix: 'alarms'
});

User = require('../models/user');

Alarm = require('../models/alarm');

module.exports.fetch = function(req, res, next, id) {
  return Alarm.find(id, function(err, alarm) {
    if (err || !alarm) {
      return res.send({
        error: true,
        msg: "Alarm not found"
      }, 404);
    } else {
      req.alarm = alarm;
      return next();
    }
  });
};

module.exports.all = function(req, res) {
  return Alarm.all(function(err, alarms) {
    var alarm, index, _i, _len;
    if (err) {
      return res.send({
        error: 'Server error occurred while retrieving data'
      });
    } else {
      for (index = _i = 0, _len = alarms.length; _i < _len; index = ++_i) {
        alarm = alarms[index];
        alarms[index] = alarm.timezoned();
      }
      return res.send(alarms);
    }
  });
};

module.exports.read = function(req, res) {
  return res.send(req.alarm.timezoned());
};

module.exports.create = function(req, res) {
  var alarm, create, data, trigg;
  data = Alarm.toUTC(req.body, req.body.timezone);
  create = function() {
    return Alarm.create(data, function(err, alarm) {
      if (err) {
        return res.send({
          error: "Server error while creating alarm."
        }, 500);
      } else {
        alarm = alarm.timezoned();
        return res.send(alarm, 201);
      }
    });
  };
  if (data["import"]) {
    alarm = new Alarm(data);
    trigg = alarm.getCouchDate();
    return Alarm.request('byDate', {
      key: trigg
    }, function(err, alarms) {
      if (err) {
        console.log(err);
        return create();
      } else if (alarms.length === 0) {
        return create();
      } else if (data.description === alarms[0].description) {
        log.warn('Alarm already exists, it was not created.');
        return res.send(alarms[0].timezoned(), 201);
      } else {
        return create();
      }
    });
  } else {
    return create();
  }
};

module.exports.update = function(req, res) {
  var data;
  data = Alarm.toUTC(req.body);
  return req.alarm.updateAttributes(data, (function(_this) {
    return function(err, alarm) {
      if (err != null) {
        return res.send({
          error: "Server error while saving alarm"
        }, 500);
      } else {
        alarm = alarm.timezoned();
        return res.send(alarm, 200);
      }
    };
  })(this));
};

module.exports["delete"] = function(req, res) {
  return req.alarm.destroy(function(err) {
    if (err != null) {
      return res.send({
        error: "Server error while deleting the alarm"
      }, 500);
    } else {
      return res.send({
        success: true
      }, 200);
    }
  });
};
